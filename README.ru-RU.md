[![en](https://img.shields.io/badge/lang-en-green.svg)](https://github.com/apostoldevel/db-platform/blob/master/README.md)

# PostgreSQL Framework for Backend Development

Программная платформа (фреймворк), построенная на основе PostgreSQL, для разработки серверной части автоматизированных информационных систем. Превращает PostgreSQL в полноценный сервер приложений со встроенным REST API, аутентификацией, механизмом рабочих процессов, файловым хранилищем и бизнес-логикой — всё на PL/pgSQL.

## Ключевые возможности

- **Механизм рабочих процессов** — жизненный цикл сущностей на основе конечных автоматов: состояния, действия, методы, переходы и обработчики событий
- **Система сущностей** — иерархическая объектная модель с наследованием: объекты, справочники (каталоги) и документы (бизнес-записи)
- **Аутентификация и авторизация** — OAuth 2.0, JWT-токены, управление сессиями, ролевой контроль доступа
- **REST API** — автоматически генерируемые эндпоинты с поддержкой спецификации OpenAPI и Swagger UI (414+ маршрутов)
- **Файловое хранилище** — виртуальная файловая система с UNIX-подобными правами доступа и поддержкой S3
- **Наблюдатель (Pub/Sub)** — событийная архитектура с типизированными издателями, подписчиками и маршрутизацией по фильтрам
- **Система отчётов** — настраиваемые отчёты с древовидной структурой, формами ввода, процедурами генерации и выходными документами
- **Уведомления и журналирование** — аудит событий, пользовательские уведомления, комментарии с иерархией и структурированное логирование

## Архитектура

Платформа использует **двухуровневую архитектуру**:

```
sql/
  platform/        ← Слой фреймворка (этот репозиторий). Переиспользуется между проектами.
  configuration/   ← Слой приложения. Код вашего проекта размещается здесь.
```

Порядок выполнения: сначала platform, затем configuration. Оба уровня используют общие схемы:

| Схема | Назначение |
|-------|------------|
| `db` | Все таблицы (всегда с префиксом `db.имя_таблицы`) |
| `kernel` | Основная бизнес-логика (в `search_path` — без префикса) |
| `api` | Внешние API-представления и CRUD-функции |
| `rest` | Диспетчеры REST-эндпоинтов |
| `oauth2` | Инфраструктура OAuth 2.0 |
| `daemon` | Функции фоновых процессов |

## Модули

| # | Модуль | Описание | Таблицы |
|--:|--------|----------|--------:|
| 1 | kernel | Базовые типы, утилиты, поддержка JWT | — |
| 2 | oauth2 | Управление клиентами и аудиториями OAuth 2.0 | 5 |
| 3 | locale | Мультиязычность (ISO 639-1) | 1 |
| 4 | admin | Пользователи, аутентификация, сессии, контроль доступа | 18 |
| 5 | http | Очередь исходящих HTTP-запросов с обратными вызовами | 3 |
| 6 | resource | Иерархическое управление контентом с учётом локали | 2 |
| 7 | exception | Стандартизированная обработка ошибок (~84 функции) | — |
| 8 | registry | Конфигурационное хранилище «ключ-значение» | 2 |
| 9 | log | Структурированное журналирование событий | 1 |
| 10 | api | Маршрутизация REST API и логирование запросов | 4 |
| 11 | replication | Синхронизация данных между инстансами | 4 |
| 12 | daemon | Интерфейс для C++ уровня приложения | — |
| 13 | session | Установка параметров сессии | — |
| 14 | current | Получение параметров сессии | — |
| 15 | workflow | Механизм рабочих процессов на конечных автоматах | 23 |
| 16 | kladr | Классификатор адресов (КЛАДР) | 3 |
| 17 | file | Виртуальная файловая система с поддержкой S3 | 1 |
| 18 | entity | Иерархия бизнес-объектов (объекты, справочники, документы) | 27 |
| 19 | notice | Система пользовательских уведомлений | 1 |
| 20 | comment | Иерархическая система комментариев | 1 |
| 21 | notification | Аудит событий и рассылка уведомлений | 1 |
| 22 | verification | Верификация по email и телефону | 1 |
| 23 | observer | Событийная система Pub/Sub | 2 |
| 24 | report | Фреймворк определения и генерации отчётов | 5 |
| 25 | reports | Готовые определения отчётов и процедуры | — |

## Быстрый старт

**Требования:** PostgreSQL 12+ и клиент командной строки `psql`.

```bash
# 1. Настройте пользователей БД в ~/.pgpass
echo '*:*:*:kernel:kernel' >> ~/.pgpass
echo '*:*:*:admin:admin'   >> ~/.pgpass
echo '*:*:*:daemon:daemon' >> ~/.pgpass
chmod 600 ~/.pgpass

# 2. Добавьте в postgresql.conf и перезапустите PostgreSQL
#    search_path = '"$user", kernel, public'

# 3. Первоначальная установка
cd db/
./runme.sh --init       # Создаёт пользователей и базу данных
```

**Повседневная разработка:**

```bash
./runme.sh --update     # Безопасно: обновление процедур и представлений
./runme.sh --patch      # Обновление таблиц + процедур + представлений
./runme.sh --install    # ДЕСТРУКТИВНО: пересоздание БД с начальными данными
```

## Структура каталогов

```
platform/
├── kernel/            Базовые типы и утилиты
├── oauth2/            Инфраструктура OAuth 2.0
├── locale/            Поддержка языков
├── admin/             Пользователи, аутентификация, сессии
├── http/              Исходящий HTTP-клиент
├── resource/          Управление контентом
├── exception/         Обработка ошибок
├── registry/          Конфигурационное хранилище
├── log/               Журналирование событий
├── api/               Маршрутизация REST API
├── replication/       Синхронизация данных
├── daemon/            Интерфейс C++
├── session/           Установка параметров сессии
├── current/           Получение параметров сессии
├── workflow/          Механизм рабочих процессов
├── kladr/             Классификатор адресов
├── file/              Файловое хранилище
├── entity/            Система сущностей
│   └── object/        Объекты, справочники, документы
├── notice/            Уведомления пользователей
├── comment/           Комментарии
├── notification/      Уведомления о событиях
├── verification/      Коды верификации
├── observer/          Событийная система Pub/Sub
├── report/            Фреймворк отчётов
├── reports/           Готовые отчёты
├── patch/             Скрипты миграции
├── wiki/              Исходники документации
├── create.psql        Скрипт полной установки
├── update.psql        Обновление процедур/представлений
├── patch.psql         Обновление таблиц + процедур
├── init.sql           Начальные данные
└── VERSION            Текущая версия (1.1.3c)
```

## Документация

Подробная документация доступна в [Wiki](https://github.com/apostoldevel/db-platform/wiki):

- **Концепции** — [Система](https://github.com/apostoldevel/db-platform/wiki/01-System), [Архитектура](https://github.com/apostoldevel/db-platform/wiki/02-Architecture), [Рабочие процессы](https://github.com/apostoldevel/db-platform/wiki/04-Workflow), [Отчёты](https://github.com/apostoldevel/db-platform/wiki/05-Reports)
- **Руководство по API** — [Введение](https://github.com/apostoldevel/db-platform/wiki/10-API-Introduction), [Доступ](https://github.com/apostoldevel/db-platform/wiki/11-API-Access), [Динамические методы](https://github.com/apostoldevel/db-platform/wiki/12-Dynamic-Methods), [Параметры запросов](https://github.com/apostoldevel/db-platform/wiki/13-Query-Parameters)
- **Внутреннее устройство** — [Обзор схем](https://github.com/apostoldevel/db-platform/wiki/60-Schema-Overview), [Таблицы БД](https://github.com/apostoldevel/db-platform/wiki/61-Database-Tables), [Справочник функций](https://github.com/apostoldevel/db-platform/wiki/62-Function-Reference), [Система сущностей](https://github.com/apostoldevel/db-platform/wiki/63-Entity-System-Internals)
- **Руководство разработчика** — [Конфигурация](https://github.com/apostoldevel/db-platform/wiki/70-Configuration-Guide), [Создание сущности](https://github.com/apostoldevel/db-platform/wiki/71-Creating-Entity), [Настройка рабочих процессов](https://github.com/apostoldevel/db-platform/wiki/74-Workflow-Customization), [REST-эндпоинты](https://github.com/apostoldevel/db-platform/wiki/75-REST-Endpoint-Guide)
- **Эксплуатация** — [Установка](https://github.com/apostoldevel/db-platform/wiki/80-Installation)

## Реализованные проекты

* [Ship Safety ERP](https://ship-safety.ru) — Автоматизированная ERP-система управления безопасностью для судоходных компаний
* [CopyFrog](https://copyfrog.ai) — Платформа на базе ИИ для создания уникальных изображений, рекламных текстов, видеокреативов и маркетинговых описаний
* [Talking to AI](https://t.me/TalkingToAIBot) — Чат-бот в Telegram для общения с искусственным интеллектом
* [OCPP CSS](http://ocpp-css.ru) — Облачная SaaS-платформа для управления зарядными станциями для электромобилей
* [PlugMe](https://plugme.ru) — Система управления зарядными станциями (CSMS)
* [DEBT-Master](https://debt-master.ru) — Система автоматизации работы с дебиторской задолженностью потребителей за коммунальные услуги
* [BitDeals](https://testnet.bitdeals.org/info/about) — Арбитражная платформа для совершения сделок с использованием криптовалюты BTC

## Лицензия

[MIT](LICENSE)
